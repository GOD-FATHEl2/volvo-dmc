name: ğŸŒ VOLVO DMC - Multi-User Online Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: nawoar.azurecr.io
  IMAGE_NAME: volvo-dmc
  RESOURCE_GROUP: app-7592-online-nonprod-001
  CONTAINER_APP: volvo-dmc-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Login to Azure
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: ğŸ” Login to Container Registry
      run: |
        echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.ACR_USERNAME }}" --password-stdin

    - name: ğŸ—ï¸ Build & Push Docker Image
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: ğŸš€ Deploy to Container App
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: âœ… Deployment Success
      run: |
        echo "ğŸ‰ VOLVO DMC is now LIVE for multiple users!"
        echo "ğŸŒ URL: https://volvo-dmc-app.braveground-410ffbbc.swedencentral.azurecontainerapps.io/"
        echo "ğŸ‘¥ Ready for global access!"
        echo "ğŸ”‘ Login: admin/admin"
