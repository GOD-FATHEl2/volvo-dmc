name: Build and Deploy VOLVO DMC to Azure Container Apps

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

env:
  REGISTRY: nawoar.azurecr.io
  IMAGE_NAME: volvo-dmc
  RESOURCE_GROUP: nawoar
  CONTAINER_APP: volvo-dmc-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry
      run: az acr login --name nawoar

    - name: Build and push Docker image
      run: |
        az acr build --registry nawoar \
          --image ${{ env.IMAGE_NAME }}:latest \
          --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
          .

    - name: Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Get Container App URL
      run: |
        URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv)
        echo "ðŸš€ VOLVO DMC deployed successfully!"
        echo "ðŸ“± Access your app at: https://$URL"
        echo "ðŸ”‘ Login with: admin/admin"
