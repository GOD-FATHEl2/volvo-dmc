name: Build and Push VOLVO DMC to ACR

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to ACR
      run: |
        echo "${{ secrets.AZURE_ACR_PASSWORD }}" | docker login ${{ secrets.AZURE_ACR_LOGIN_SERVER }} -u ${{ secrets.AZURE_ACR_USERNAME }} --password-stdin

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.AZURE_ACR_LOGIN_SERVER }}/${{ secrets.AZURE_ACR_REPO_NAME }}:latest .

    - name: Push Docker image to ACR
      run: |
        docker push ${{ secrets.AZURE_ACR_LOGIN_SERVER }}/${{ secrets.AZURE_ACR_REPO_NAME }}:latest

    - name: Update Container App
      run: |
        # Install Azure CLI
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        
        # Login to Azure using service principal
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}
        
        # Update Container App
        az containerapp update \
          --name volvo-dmc-app \
          --resource-group nawoar \
          --image ${{ secrets.AZURE_ACR_LOGIN_SERVER }}/${{ secrets.AZURE_ACR_REPO_NAME }}:latest \
          --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Display success message
      run: |
        echo "ðŸŽ‰ VOLVO DMC successfully deployed!"
        echo "ðŸ“± Access your app at: https://volvo-dmc-app.braveground-410ffbbc.swedencentral.azurecontainerapps.io/"
        echo "ðŸ”‘ Login with: admin/admin"
